
<!doctype html>
<html>
<head>
<meta charset='utf-8'/>
<title>MAGport Report</title>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<script src='https://cdn.plot.ly/plotly-2.29.1.min.js'></script>
<link rel='stylesheet' href='https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css'/>
<link rel='stylesheet' href='https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css'/>
<script src='https://code.jquery.com/jquery-3.7.0.min.js'></script>
<script src='https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js'></script>
<script src='https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js'></script>
<script src='https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js'></script>
<style>
body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 0; background: #f8f9fa; }
h1 { margin: 1em 0 0.5em 0; text-align: center; }
.container { max-width: 1200px; margin: auto; padding: 1em; }
.viz-block { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; margin-bottom: 2em; padding: 1em; }
@media (max-width: 900px) { .viz-block, #summary { width: 100% !important; } }
</style>
</head>
<body>
<div class='container'>
<h1>MAGport Report</h1>
<p>Analyzed <b>3</b> MAGs from <code>/mnt/hpccs01/work/microbiome/users/heyu/MAGport/test/test_output/</code></p>

<div class='viz-block'>
  <div id='quality_pie' style='width:100%;height:400px;'></div>
</div>
<div class='viz-block'>
  <div id='scatter' style='width:100%;height:500px;'></div>
</div>
<div class='viz-block'>
  <div id='taxa_bar' style='width:100%;height:500px;'></div>
</div>
<div class='viz-block'>
  <div id='dists' style='width:100%;height:500px;'></div>
</div>
<div class='viz-block'>
  <div id='radar' style='width:100%;height:500px;'></div>
</div>
<div class='viz-block'>
  <table id='summary' class='display' style='width:100%'></table>
</div>
</div>
<script>
const data = [{"MAG": "GCF_024346955.1_vmangrovi", "num_contigs": 2, "genome_size_bp": 5007139, "N50": 3674542, "GC": 45.62, "sum_ambiguous_bases": 0, "num_ORFs": 4345, "Completeness": 100.0, "Contamination": 0.0, "GUNC_status": true, "Park_Score": 99.9, "MIMAG_level": "HQ", "num_tRNAs": 95, "num_16S_rRNAs": 8, "num_23S_rRNAs": 8, "num_5S_rRNAs": 9, "16S_NCBI_taxonomy": "Vibrio mangrovi strain MSSRF38 16S ribosomal RNA, partial sequence", "16S_blastn_identity": 99.928, "GTDB_taxonomy": "d__Bacteria;p__Pseudomonadota;c__Gammaproteobacteria;o__Enterobacterales;f__Vibrionaceae;g__Vibrio;s__Vibrio mangrovi"}, {"MAG": "MAG1", "num_contigs": 28, "genome_size_bp": 903669, "N50": 68826, "GC": 38.27, "sum_ambiguous_bases": 0, "num_ORFs": 1029, "Completeness": 93.95, "Contamination": 0.0, "GUNC_status": true, "Park_Score": 92.55, "MIMAG_level": "MQ", "num_tRNAs": 45, "num_16S_rRNAs": 1, "num_23S_rRNAs": 1, "num_5S_rRNAs": 0, "16S_NCBI_taxonomy": "Methanobacterium kanagiense strain 169 16S ribosomal RNA, partial sequence", "16S_blastn_identity": 77.045, "GTDB_taxonomy": "d__Archaea;p__Aenigmatarchaeota;c__Aenigmatarchaeia;o__Aenigmatarchaeales;f__Aenigmatarchaeaceae;g__;s__"}, {"MAG": "MAG209", "num_contigs": 240, "genome_size_bp": 1863239, "N50": 10236, "GC": 45.01, "sum_ambiguous_bases": 0, "num_ORFs": 2002, "Completeness": 91.26, "Contamination": 1.88, "GUNC_status": true, "Park_Score": 69.86, "MIMAG_level": "MQ", "num_tRNAs": 35, "num_16S_rRNAs": 1, "num_23S_rRNAs": 0, "num_5S_rRNAs": 0, "16S_NCBI_taxonomy": "Infirmifilum uzonense strain 1807-2 16S ribosomal RNA, complete sequence", "16S_blastn_identity": 79.051, "GTDB_taxonomy": "d__Archaea;p__Thermoproteota;c__Bathyarchaeia;o__Bathyarchaeales;f__Bathycorpusculaceae;g__A05DMB-2;s__"}];
$(document).ready(function() {
  // DataTable
  const cols = Object.keys(data[0] || {}).map(k => ({title:k, data:k}));
  const colIndex = Object.fromEntries(cols.map((c,i)=>[c.title,i]));
  const table = $('#summary').DataTable({
    data: data,
    columns: cols,
    dom: 'Bfrtip',
    buttons: ['copyHtml5','csvHtml5','excelHtml5'],
    responsive: true
  });

  // MIMAG Quality Pie
  let qCol = colIndex['MIMAG_level'] || colIndex['MIMAG_Quality'];
  if (qCol !== undefined) {
    const qCounts = {};
    data.forEach(r=>{ const q=r[cols[qCol].title]||'NA'; qCounts[q]=(qCounts[q]||0)+1; });
    const labels = Object.keys(qCounts); const values = labels.map(k=>qCounts[k]);
    Plotly.newPlot('quality_pie', [{type:'pie', labels, values, hole:0.3}], {title:'MIMAG Quality Distribution'});
    document.getElementById('quality_pie').on('plotly_click', ev=>{
      const lab = ev.points?.[0]?.label; if(!lab) return;
      table.column(qCol).search('^'+lab+'$', true, false).draw();
    });
  }

  // Completeness vs Contamination Scatter
  let compCol = colIndex['Completeness'], contCol = colIndex['Contamination'], magCol = colIndex['MAG'] || colIndex['MAG_ID'];
  if (compCol !== undefined && contCol !== undefined) {
    const xs = data.map(r=>parseFloat(r[cols[contCol].title])||0);
    const ys = data.map(r=>parseFloat(r[cols[compCol].title])||0);
    const text = data.map(r=>r[cols[magCol]?.title]||'');
    const size = data.map(r=>Math.max(10, Math.min(80, (parseFloat(r['genome_size_bp']||r['Genome_Size'])||0)/5e5 )));
    const color = data.map(r=>r['GTDB_taxonomy']?.split(';')[1]?.replace('p__','')||'');
    Plotly.newPlot('scatter', [{
      x:xs,
      y:ys,
      text,
      mode:'markers',
      marker:{size, color, opacity:0.8},
      type:'scattergl'
    }], {
      title:'Completeness vs Contamination', xaxis:{title:'Contamination (%)'}, yaxis:{title:'Completeness (%)'}
    });
    document.getElementById('scatter').on('plotly_selected', ev=>{
      if(!ev || !ev.points) return; const ids = new Set(ev.points.map(p=>text[p.pointIndex]));
      $.fn.dataTable.ext.search = [function(settings, rowData, dataIndex) { return ids.size===0 || ids.has(rowData[magCol]); }];
      table.draw();
    });
  }

  // GTDB Taxonomy Bar (Phylum)
  let gtdbCol = colIndex['GTDB_taxonomy'];
  if (gtdbCol !== undefined) {
    const pCounts = {};
    data.forEach(r=>{
      let phylum = (r['GTDB_taxonomy']||'').split(';')[1]||'Unassigned';
      phylum = phylum.replace('p__','')||'Unassigned';
      pCounts[phylum]=(pCounts[phylum]||0)+1;
    });
    const taxa = Object.keys(pCounts).sort((a,b)=>pCounts[b]-pCounts[a]).slice(0,20);
    const vals = taxa.map(k=>pCounts[k]);
    Plotly.newPlot('taxa_bar', [{type:'bar', x:vals, y:taxa, orientation:'h'}], {title:'Top Phyla (GTDB)'});
    document.getElementById('taxa_bar').on('plotly_click', ev=>{
      const ph = ev.points?.[0]?.y; if(!ph) return;
      table.column(gtdbCol).search(ph, true, false).draw();
    });
  }

  // Distributions: Genome Size, N50, GC
  const distFields = ['genome_size_bp','N50','GC'];
  const traces = distFields.filter(f=>colIndex[f]!==undefined).map(f=>({x: data.map(r=>parseFloat(r[f])||0), type:'histogram', name:f, opacity:0.6}));
  if (traces.length) { Plotly.newPlot('dists', traces, {barmode:'overlay', title:'Distributions'}); }

  // Radargram for key traits
  let radarFields = ['Completeness','Contamination','GC','num_16S_rRNAs','num_ORFs'];
  let radarData = data.map(r=>radarFields.map(f=>parseFloat(r[f])||0));
  if (radarData.length) {
    let means = radarFields.map((f,i)=>radarData.map(row=>row[i]).reduce((a,b)=>a+b,0)/radarData.length);
    Plotly.newPlot('radar', [{type:'scatterpolar', r:means, theta:radarFields, fill:'toself', name:'Mean'}], {title:'Mean Traits Radargram'});
  }
});
</script>
</body>
</html>
